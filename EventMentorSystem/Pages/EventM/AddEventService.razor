@using EMS.DB.Models
@using  EMS.DB.Repository.Interface
@inject IEventRepository _eventService;
@inject IEventCategoryRepository _EventCategoryRepository;
@inject ICategoryServiceRepository _CategoryServiceRepository;
@inject ISnackbar Snackbar;

<MudDialog>
    <DialogContent>
        <MudSelect @bind-Value="eventModel.CategoryId" T="long" SelectedValuesChanged="@(e => OnEventCategoryChange(e.FirstOrDefault()))" Label="select categorys" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" ReadOnly="true">
            <MudSelectItem Value="@eventModel.CategoryId">@eventModel.Category.CategoryName</MudSelectItem>
        </MudSelect>
        @*@bind-Value="@(e => SetSelectedServices(e))" @bind-SelectedValues="@GetSelectedServices()"  SelectedValuesChanged="@(e => OnSetSelectedServices((IEnumerable<long>)e))"*@
        <MudSelect  Value="@GetSelectedServices()" MultiSelection="true" Label="select Services" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
            @foreach (var Service in GetCategoryServices())
            {
                <MudSelectItem T="long" Value="@Service.Id">@Service.ServiceName</MudSelectItem>
            }
        </MudSelect>
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Filled" Color="Color.Default" OnClick="Cancel">Cancel</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="AddService">Add Service</MudButton>
    </DialogActions>
</MudDialog>

@code {
    private String demo { get; set; }
    [CascadingParameter] MudDialogInstance MudDialog { get; set; }
    [Parameter] public Event EventModel { get; set; } = new Event();
    private Event eventModel = new();
    private bool isReadOnly = false;
    private EventCategory EventCategoryName = new();
    private CategoryService CategoryServiceModel = new();
    private List<CategoryService> ServiceList = new();
    private List<EventCategory> EventCategoryList = new();
    private List<String> options { get; set; } = new List<string>();
    protected override void OnInitialized()
    {
        if (EventModel is not null && EventModel.Id > 0)
        {
            isReadOnly = true;
        }
        eventModel = EventModel;
        base.OnInitialized();
    }
    protected override Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            EventCategoryName = _EventCategoryRepository.GetById(EventModel.CategoryId);
            GetEventCategoryList();
            GetCategoryServices();
            GetAllService();
            StateHasChanged();
        }

        return base.OnAfterRenderAsync(firstRender);
    }
    public void OnEventCategoryChange(long selectedEventCategoryId)
    {
    }
    public List<CategoryService> GetCategoryServices()
    {

        return ServiceList.Where(x => x.EventCategoryId == EventModel.CategoryId).ToList();
    }

    private void GetEventCategoryList()
    {
        EventCategoryList = _EventCategoryRepository.GetList();
    }
    private List<CategoryService> GetAllService()
    {
        ServiceList = _CategoryServiceRepository.GetList();
        return ServiceList;
    }
    void Cancel() => MudDialog.Close(DialogResult.Ok(false));
    private void AddService()
    {
        try
        {
            _eventService.Update(eventModel);
            eventModel = new Event();
            MudDialog.Close();
        }
        catch (Exception ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
    }
    private IEnumerable<long> GetSelectedServices()
    {
        return eventModel.SelectedService.Split(',').Select(x => Convert.ToInt64(x));

    }
    //IEnumerable<long>
    private IEnumerable<long> OnSetSelectedServices(IEnumerable<long> values)
    {
        return eventModel.SelectedService.Split(',').Select(x => Convert.ToInt64(x)).ToList();
    }
}