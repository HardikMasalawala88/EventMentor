@using EMS.DB.Models
@using  EMS.DB.Repository.Interface
@inject IEventRepository _eventService;
@inject IEventCategoryRepository _EventCategoryRepository;
@inject ICategoryServiceRepository _CategoryServiceRepository;
@inject ISnackbar Snackbar;

<MudDialog>
    <DialogContent>
        <MudGrid>
            <MudItem>
                <MudSelect @bind-Value="eventModel.CategoryId" T="long" SelectedValuesChanged="@(e => OnEventCategoryChange(e.FirstOrDefault()))" Label="select categorys" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" ReadOnly="true">
                    <MudSelectItem Value="@eventModel.CategoryId">@eventModel.Category.CategoryName</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem>
                <MudSelect T="string"  @bind-Value="@eventModel.SelectedService" MultiSelection="true" Label="select Services" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                    @foreach (var Service in GetAllService())
                    {
                        <MudSelectItem T="string" Value="@Service.Id.ToString()">@Service.ServiceName</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
           
           
           
        </MudGrid>
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Filled" Color="Color.Default" OnClick="Cancel">Cancel</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="AddService">Add Service</MudButton>
    </DialogActions>
</MudDialog>

@code {
   
    [CascadingParameter] MudDialogInstance MudDialog { get; set; }
    [Parameter] public Event EventModel { get; set; } = new Event();
    private Event eventModel = new();
    private bool isReadOnly = false;
    private EventCategory EventCategoryName = new();
    private CategoryService CategoryServiceModel = new();
    private List<CategoryService> ServiceList = new();
    private List<EventCategory> EventCategoryList = new();
    protected override void OnInitialized()
    {
        if (EventModel is not null && EventModel.Id > 0)
        {
            isReadOnly = true;
        }
        eventModel = EventModel;
        base.OnInitialized();
    }
    protected override Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            EventCategoryName = _EventCategoryRepository.GetById(EventModel.CategoryId);
            GetEventCategoryList();
            //GetCategoryServices();
            GetAllService();
            StateHasChanged();
        }

        return base.OnAfterRenderAsync(firstRender);
    }
    public void OnEventCategoryChange(long selectedEventCategoryId)
    {
    }
    private void GetEventCategoryList()
    {
        EventCategoryList = _EventCategoryRepository.GetList();
    }
    private List<CategoryService> GetAllService()
    {
        ServiceList = _CategoryServiceRepository.GetList();
        return ServiceList;
    }
    void Cancel() => MudDialog.Close(DialogResult.Ok(false));
    private void AddService()
    {
        try
        {
            _eventService.Update(eventModel);
            eventModel = new Event();
            MudDialog.Close();
            Snackbar.Add("add service successfully.", Severity.Success);

        }
        catch (Exception ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
    }

    private string GetSelectedServices()
    {
        return eventModel.SelectedService;
        //return eventModel.SelectedService.Split(',').Where(x    => string.IsNullOrEmpty(x)).ToList();
    }

    //IEnumerable<long>
    private IEnumerable<long> OnSetSelectedServices(IEnumerable<long> values)
    {
        return eventModel.SelectedService.Split(',').Select(x => Convert.ToInt64(x)).ToList();
    }
}